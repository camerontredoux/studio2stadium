generator client {
  provider = "prisma-kysely"
  fileName = "../../generated/types.ts"
}

datasource db {
  provider = "postgresql"
}

/**
 * **************
 * AUTHENTICATION
 * **************
 */

model User {
  id            String      @id @default(dbgenerated("gen_random_uuid()"))
  username      String      @unique @db.Citext
  email         String      @unique @db.Citext
  role          Role
  account_type  AccountType
  display_email String
  first_name    String
  last_name     String
  password      String
  avatar        String?
  phone         String?

  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  dancer_account  DancerAccount?
  school_account  SchoolAccount?
  subscriptions   Subscription?
  notifications   Notification[]
  hidden_items    HiddenItem[]
  user_activities UserActivity[]
  media           ProfileMedia[]

  prodigy_dance_events ProdigyDanceEventAttendee[]
  global_dance_events  GlobalDanceEventAttendee[]
  school_dance_events  SchoolDanceEventAttendee[]

  followers Favorite[] @relation("followers")
  following Favorite[] @relation("following")

  @@index([created_at])
  @@map("users")
}

model UserActivity {
  id            String        @id @default(dbgenerated("gen_random_uuid()"))
  event_type    String
  platform_name PlatformName?

  user_id String
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  created_at DateTime @default(now())

  @@index([user_id, created_at])
  @@index([created_at, event_type])
  @@map("user_activities")
}

/**
 * ********
 * ACCOUNTS
 * ********
 */

model DancerAccount {
  id             String   @id @default(dbgenerated("gen_random_uuid()"))
  user_id        String   @unique
  birthday       DateTime @db.Date
  biography      String?
  awards         String?
  instagram      String?
  tiktok         String?
  youtube        String?
  location       String?
  skill_level    String?
  team_level     String?
  high_school    String?
  studio         String?
  gpa            Float?
  grad_year      Int?
  training_hours Int?

  achievements DancerAchievements[]
  references   DancerReferences[]

  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  platforms DancerPlatform[]

  @@index([grad_year])
  @@index([location])
  @@map("dancer_accounts")
}

model SchoolAccount {
  id                 String   @id @default(dbgenerated("gen_random_uuid()"))
  user_id            String   @unique
  name               String   @unique
  location           String
  division           String?
  benefits           String?
  about              String?
  website            String?
  time_commitment    String?
  head_coach         String?
  assistant_coach    String?
  tiktok             String?
  instagram          String?
  mission_statement  String?
  what_we_do         String?
  skill_requirements String?
  competitions       String[]
  dance_styles       String[]
  sports             String[]
  gpa_requirement    Float?
  school_size        Int?

  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  events SchoolDanceEvent[]

  @@index([gpa_requirement])
  @@index([school_size])
  @@map("school_accounts")
}

/**
 * *******
 * PROFILE
 * *******
 */

model ProfileMedia {
  id       String  @id @default(dbgenerated("gen_random_uuid()"))
  user_id  String
  media_id String  @unique
  caption  String?

  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  hidden_by HiddenItem[]

  @@index([user_id, created_at])
  @@map("user_profile_media")
}

model HiddenItem {
  id String @id @default(dbgenerated("gen_random_uuid()"))

  created_at DateTime @default(now())

  hidden_by_id String
  hidden_by    User   @relation(fields: [hidden_by_id], references: [id], onDelete: Cascade)

  media_id String?
  media    ProfileMedia? @relation(fields: [media_id], references: [id], onDelete: Cascade)

  @@unique([hidden_by_id, media_id])
  @@map("user_hidden_items")
}

/**
 * *************
 * NOTIFICATIONS
 * *************
 */

model OutboxEvent {
  id      String @id @default(dbgenerated("gen_random_uuid()"))
  type    String
  payload Json

  created_at   DateTime  @default(now())
  published_at DateTime?

  @@index([type])
  @@index([published_at])
  @@map("event_outbox")
}

model Notification {
  id      String @id @default(dbgenerated("gen_random_uuid()"))
  user_id String
  content Json

  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at])
  @@map("notifications")
}

model GlobalNotification {
  id         String   @id @default(dbgenerated("gen_random_uuid()"))
  content    Json
  created_at DateTime @default(now())

  @@index([created_at])
  @@map("global_notifications")
}

model ProcessedEvent {
  event_id   String @id
  event_type String

  processed_at DateTime @default(now())

  @@map("processed_events")
}

/**
 * *********
 * PLATFORMS
 * *********
 */

model Platform {
  name PlatformName @id

  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  dancers   DancerPlatform[]
  favorites Favorite[]

  @@map("platforms")
}

model DancerPlatform {
  account_id    String
  platform_name PlatformName
  account       DancerAccount @relation(fields: [account_id], references: [id], onDelete: Cascade)
  platform      Platform      @relation(fields: [platform_name], references: [name], onDelete: Cascade)

  joined_at DateTime @default(now())

  @@id([account_id, platform_name])
  @@index([platform_name])
  @@map("dancer_platforms")
}

model Favorite {
  id                String       @id @default(dbgenerated("gen_random_uuid()"))
  from_user_id      String
  to_user_id        String
  platform_name     PlatformName
  comment           String?
  rating            Int?         @db.SmallInt
  last_contacted    DateTime?
  last_notification DateTime?

  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  platform  Platform @relation(fields: [platform_name], references: [name], onDelete: Cascade)
  from_user User     @relation("followers", fields: [from_user_id], references: [id], onDelete: Cascade)
  to_user   User     @relation("following", fields: [to_user_id], references: [id], onDelete: Cascade)

  @@unique([from_user_id, to_user_id, platform_name])
  @@map("user_favorites")
}

/**
 * *******
 * DANCERS
 * *******
 */

model DancerAchievements {
  id        String @id @default(dbgenerated("gen_random_uuid()"))
  dancer_id String
  content   String

  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  dancer DancerAccount @relation(fields: [dancer_id], references: [id], onDelete: Cascade)

  @@index([dancer_id])
  @@map("dancer_achievements")
}

model DancerReferences {
  id        String @id @default(dbgenerated("gen_random_uuid()"))
  dancer_id String
  url       String

  created_at DateTime  @default(now())
  deleted_at DateTime? @updatedAt

  dancer DancerAccount @relation(fields: [dancer_id], references: [id], onDelete: Cascade)

  @@index([dancer_id])
  @@map("dancer_references")
}

/**
 * ******
 * EVENTS
 * ******
 */

model SchoolDanceEvent {
  id          String  @id @default(dbgenerated("gen_random_uuid()"))
  school_id   String
  title       String
  description String?
  website     String?

  start_datetime DateTime
  end_datetime   DateTime
  timezone       String

  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  host SchoolAccount @relation(fields: [school_id], references: [id], onDelete: Cascade)

  attendees SchoolDanceEventAttendee[]

  @@index([school_id])
  @@index([start_datetime])
  @@map("school_dance_events")
}

model SchoolDanceEventAttendee {
  event_id String
  event    SchoolDanceEvent @relation(fields: [event_id], references: [id], onDelete: Cascade)
  user_id  String
  user     User             @relation(fields: [user_id], references: [id], onDelete: Cascade)

  registered_at DateTime @default(now())

  @@id([event_id, user_id])
  @@index([user_id])
  @@map("school_dance_event_attendees")
}

model GlobalDanceEvent {
  id           String @id @default(dbgenerated("gen_random_uuid()"))
  name         String
  location     String
  description  String
  website      String
  organization String
  thumbnail    String

  start_datetime DateTime
  end_datetime   DateTime
  timezone       String

  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  attendees GlobalDanceEventAttendee[]

  @@index([start_datetime])
  @@map("global_dance_events")
}

model GlobalDanceEventAttendee {
  event_id String
  event    GlobalDanceEvent @relation(fields: [event_id], references: [id], onDelete: Cascade)
  user_id  String
  user     User             @relation(fields: [user_id], references: [id], onDelete: Cascade)

  registered_at DateTime @default(now())

  @@id([event_id, user_id])
  @@index([user_id])
  @@map("global_dance_event_attendees")
}

/**
 * *******
 * PRODIGY
 * *******
 */

/**
 * Tables are kept separate despite duplication for the following reasons:
 * 1. Future proofing for different business logic
 * - DRY means "don't repeat business logic", it doesn't mean "don't repeat code"
 * 2. Prodigy is white-labeled and we legally can't leak data, so:
 * - Deleting all Prodigy events is as simple as dropping this table
 * - Accidentally uploading a Prodigy event as a Global event is impossible
 */

model ProdigyDanceEvent {
  id           String  @id @default(dbgenerated("gen_random_uuid()"))
  name         String
  location     String
  schedule     String?
  description  String?
  organization String?
  website      String?

  start_datetime DateTime
  end_datetime   DateTime
  timezone       String

  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  attendees ProdigyDanceEventAttendee[]
  videos    ProdigyLibraryVideo[]

  @@index([start_datetime])
  @@map("prodigy_dance_events")
}

model ProdigyDanceEventAttendee {
  bib_number String
  paid_tier  Boolean

  registered_at DateTime @default(now())

  event_id String
  event    ProdigyDanceEvent @relation(fields: [event_id], references: [id], onDelete: Cascade)
  user_id  String
  user     User              @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([event_id, user_id])
  @@index([user_id])
  @@map("prodigy_dance_event_attendees")
}

model ProdigyLibraryVideo {
  id          String @id @default(dbgenerated("gen_random_uuid()"))
  instructor  String
  youtube_id  String
  title       String
  description String

  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  event_id String
  event    ProdigyDanceEvent @relation(fields: [event_id], references: [id], onDelete: Cascade)

  @@index([instructor, event_id])
  @@index([created_at])
  @@map("prodigy_library_videos")
}

/**
 * ********
 * PAYMENTS
 * ********
 */

model Subscription {
  id                   String             @id @default(dbgenerated("gen_random_uuid()"))
  source               SubscriptionSource
  user_id              String             @unique
  subscription_id      String             @unique
  customer_id          String?
  cancel_at_period_end Boolean            @default(false)
  current_period_end   DateTime?
  canceled_at          DateTime?

  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([current_period_end])
  @@index([source])
  @@map("user_subscriptions")
}

/**
 * ******
 * GLOBAL
 * ******
 */

model VideoLibrary {
  id         String @id @default(dbgenerated("gen_random_uuid()"))
  category   String
  youtube_id String
  title      String

  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  @@index([created_at])
  @@map("video_library")
}

/**
 * *****
 * ENUMS
 * *****
 */

enum ProspectStatus {
  none
  released
  in_review
  accepted
}

enum MediaType {
  image
  video
}

enum SubscriptionSource {
  stripe
  revenuecat
}

enum PlatformName {
  core
  prodigy
}

enum Role {
  admin
  prodigy_admin
  user
}

enum AccountType {
  dancer
  school
}
