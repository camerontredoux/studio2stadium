# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Package Overview

This is `@tuyau/openapi`, an AdonisJS package that automatically generates OpenAPI 3.1 documentation from TypeScript API definitions. It's part of the Tuyau ecosystem and provides runtime routes for serving API documentation.

## Common Commands

```bash
# Build the package
pnpm build

# Type check without emitting
pnpm typecheck

# Format code
pnpm format

# Run tests (requires tsnode.esm.js)
pnpm quick:test
```

## Architecture

### Core Flow

1. **Type Analysis** (`src/footprint.ts`): Uses ts-morph to recursively resolve TypeScript types into a "footprint" - a fully expanded type definition. Takes an interface like `interface A { user: User }` and resolves it to `interface A { user: { id: string, name: string } }`.

2. **OpenAPI Generation** (`src/generator.ts`): `OpenApiGenerator` class reads the `.adonisjs/api.ts` file (generated by @tuyau/core), creates a footprint of the `ApiDefinition` interface, then walks the type tree converting TypeScript types to OpenAPI 3.1 schema objects.

3. **Route Metadata** (`src/meta_store.ts`): Stores OpenAPI metadata attached to routes via the `.openapi()` macro. The `MetaStore` holds route-level overrides that get merged with auto-generated specs.

4. **Route Macros** (`src/bindings/routes.ts`): Adds `.openapi()` method to AdonisJS Route, RouteResource, and RouteGroup classes, allowing route-level OpenAPI customization in route files.

### Entry Points

- `providers/openapi_provider.ts`: Registers `/docs` and `/openapi` routes. In dev mode, generates spec on-the-fly; in production, reads from disk.
- `commands/generate.ts`: `tuyau:generate:openapi` ace command for generating `openapi.json`.
- `src/hooks/build_hook.ts`: Assembler hook that runs during `node ace build` to generate the production spec file.

### UI Renderers

- `src/scalar/renderer.ts`: Renders Scalar API reference UI (default)
- `src/swagger/renderer.ts`: Renders Swagger UI

### Type Conversion

The generator converts TypeScript types to OpenAPI schemas:
- Primitives map directly (string, number, boolean)
- Arrays become `{ type: "array", items: {...} }`
- Union types become `oneOf` arrays
- Optional properties are tracked in `required` arrays
- Route params (`:id`) are extracted as path parameters
- Request bodies use `application/json` content type

### Configuration

Configuration is set in `config/tuyau.ts` under the `openapi` key:
- `provider`: 'scalar' | 'swagger-ui'
- `endpoints.ui`: UI route path (default: `/docs`)
- `endpoints.spec`: Spec route path (default: `/openapi`)
- `exclude`: Array of paths/regexes to exclude from docs
- `documentation`: OpenAPI document overrides
